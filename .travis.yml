language: python

sudo: required

matrix:
  fast_finish: true
  include:
    - os: linux
      python: 2.7
    - os: linux
      python: 3.5
    - os: linux
      python: 3.6
    - os: osx
      language: generic
      env:
        - PYTHON_VERSION=2.7
    - os: osx
      language: generic
      env:
        - PYTHON_VERSION=3.5
    - os: osx
      language: generic
      env:
        - PYTHON_VERSION=3.6

before_install:
  - source .ci/travis_setup.sh
  # install non-python build requirements and switch to virtualenv if necessary
  - setup_environment
  # install python build requirements
  - python -m pip install -U -r python/dev_requirements.txt

install:
  - mkdir build
  - cd build
  # build libraries
  - cmake ..
  - make
  # make python source distribution (for upload to PyPI)
  - make digital_rf_sdist
  # install python package into virtual environment for testing
  - python -m pip install dist/digital_rf-*.tar.gz

script:
  # c tests
  - make test
  - rm -r /tmp/hdf5
  # python tests
  - pushd python
  - python setup.py test --addopts '--maxfail=10'
  - popd

# Note: TWINE_USERNAME and TWINE_PASSWORD are set in Travis settings
deploy:
  provider: script
  script:
    - python -m pip install twine
    - python -m twine upload dist/*
  skip_cleanup: true
  on:
    python: 2.7
    condition: $TRAVIS_OS_NAME == 'linux'
    tags: true
